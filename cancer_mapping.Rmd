---
title: "Mapping Cancer Risk in Washington State"
author: |
  | Walker Azam
  | STAT/CSSS 554 Course Project
  | Date: March 13, 2023
output:
  pdf_document: default
  html_document: default
---

```{r setup-md, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
# Setting up RMarkdown
opts_chunk$set(collapse = TRUE, fig.align = "center", tidy = TRUE, 
               tidy.opts = list(blank = TRUE, width.cutoff = 60, 
                                strip.white = TRUE), warning = FALSE, 
               message = FALSE, cache = FALSE, echo=FALSE)
```

```{r setup, eval=T}
# Loading Libraries
library(RColorBrewer) # creates nice color schemes
library(classInt)     # finds class intervals for continuous variables
library(ggplot2)
library(rgdal)
library(SUMMER)
library(maps)
library(maptools)
library(dplyr)
library(sf)
library(INLA)
library(prioritizr)
```

## Introduction

In this project I will be mapping and predicting Cancer risk in Washington state at a census tract level. 

As noted by the Cancer Statistics Center from the American Cancer Society, there are over 441 incident cases for cancer per 100,000 people living in Washington State, 2015-2019, and an estimated 44,630 new cases for 2023. In an effort to better understand possible environmental covariate factors of cancer rates in the state, and possibly inform resource allocation and plan interventions, I would like to perform disease mapping based on exposure covariates. Personal exposure information such as individuals' diets, genetics, or smoking habits will not be considered. Rather the purpose of the project is to understand if there are environmental risk exposures such as Air Quality, or harmful chemical exposures that may have an effect on Cancer risk. Moreover, the project will aim to highlight whether particular areas in Washington state are at high risk for cancer, which can result in more specific future studies to elucidate any potential reasons and interventions.

## Data Background

The data used in this project are collected from WA state resources, all publicly available online for use. Primarily the Cancer Incident counts are retrieved from the Washington State Department of Health's source for environmental public health data the Washington Tracking Network (WTN). All Cancer type incidences were selected for this project, occurring in a 5 Year Interval between 2015-2019, for both Sexes. The counts are based on the residential address for the patient at the time of diagnosis, which may not account of types of cancers that have longer latency periods -- which is a limitation of this study. The data provided is relatively reliable, however there are 10 census tracts that have data suppressed to protect confidentiality. Since this comprises of 0.7% of the complete data, they were considered as 0 cases for the purposes of this project.

```{r read-data, fig.height=4.5, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.cap="WA State Census Tract Map"}
# Reading in WA state Census Tract Shapefiles
# Data from: https://ofm.wa.gov/washington-data-research/population-demographics/gis-data/census-geographic-files
washington <- rgdal::readOGR(dsn="tract10",layer="tract10")
plot(washington, main="Washington Census Tracts")
```

Washington has 1458 Census Tracts. From first figure it is apparent that the area between these census tracts are highly uneven. We can see that most of the tracts near the Seattle Metropolitan Area are small and dense, close by the Puget Sound. In contrast, most of the central and eastern tracts are large and rural, just past the cascade mountain range. The far east areas are also larger, close to the Olympic national mountains. 

```{r sp-data}
# Converting WA census tract to a polygon DF
wmap <- SpatialPolygons(washington@polygons) # getting Geometries
washington$geometry <- st_as_sfc(wmap) # adding geometry column
wmap <- st_as_sf(washington)
# selecting important columns
wmap <- wmap[,c("GEOID10", "TRACTCE10", "INTPTLON10", "INTPTLAT10", "geometry")]
```


```{r read-cancer}
# Reading cancer data (pre-cleaned)
cancer <- read.csv("Cancer_Incidence_2015-2019.csv", header = TRUE)
# Selecting Columns
cancer <- cancer[, c("County.Name", "Census.Tract.ID", "Count", "Population")]
# Assigning NULL values to 0
cancer$Count[cancer$Count == 'NULL'] <- 0
# Merging with spatial object
merge <- merge(cancer, wmap, by.x='Census.Tract.ID', by.y='GEOID10')
wa <- st_as_sf(merge)
# drop areas with 0 population (Water)
wa <- filter(wa, Population > 0)
```


```{r population-map, fig.height=6.5, fig.cap="WA State Population Map, 2015-2019"}
pal = function(n) brewer.pal(n, "Oranges")
plot(wa["Population"], pal = pal, nbreaks = 8, breaks = "equal", lwd=0.5,
     main="Washington State's Population", sub='Combined Census Tract Population from 2015-2019')
```

As aforementioned, this project will look at Washington State's population from 2015-2019, aggregated by census tracts, and pulled from the WTN. This includes combined age groups and sexes. The total count for the population between 2015-2019 combined is 36,529,390. We can see from the map of the populations that the Seattle Metro Area is by far the most populated areas which is expected. All regions near the Puget Sound have high populations in general, such as King and Pierce County. We can also see a trend where the smaller census tract regions have much higher populations. There are some regions of high density away from the Seattle Metro Area, such as near Spokane in the East and Grant County, however most regions in the center, far west, and east are relatively rural and sparsely populated. 

```{r cancer-raw-map, fig.height=6.5, fig.cap="Raw Cancer Incidences, 2015-2019"}
pal = function(n) brewer.pal(n, "Purples")
# Assigning it to be Numeric
wa$Count <- as.numeric(wa$Count)
plot(wa["Count"], pal = pal, nbreaks = 8, breaks = "equal", lwd=0.5,
     main="Washington State Cancer Incidence Counts", sub='All Cancer Types, 2015-2019')
```

Looking at the map for the raw count of Cancer incidences in the state between 2015-2019, we see a general concordance between areas of high population and areas of high cancer incidence counts, as expected. For example, general the large regions in the center-east have low incidence counts. However, we can see some standout regions. For example some of the census tracts in Clallam county (North-west), where the Olympic National Parks are, have highest counts (more than King County/Seattle). Also in Gray's Harbor county, on the Western Border of the map, we see a census tract with a high raw count. Generally, this map shows a trend where regions West of the Cascade mountains have a higher incidence of Cancer than those towards the East.

```{r table-1, fig.cap="Table for Totals from 2015-2019", message=FALSE, warning=FALSE}
table <- cbind('Population Total' = 36529390, 'Case Total' = 211597)
knitr::kable(table)
```

The maps shown and discussed so far represent raw counts for population and cancer incidences, and do not take into account any form of spatial smoothing. This is important for sparse areas, where counts may be unreliable. The response variable in this study would be Cancer prevalence across all age groups in WA state, and a  Poisson distribution will be assumed for the disease. Even taking the combined counts for all Cancer types, the disease is relatively rare compared to the entire combined population for the project (See Table 1). 

The standardized incidence rates (SIR) will be extrapolated from the incidence counts since morbidity data is much harder to acquire. To find the SIRs for each region, we can assume $Y_i$ and $E_i$, $i = 1,...,n$, denote the observed counts for the combined population in region $i$, $i = 1,...,n$. Assuming $SIR = Y_i/E_i$, we can observe how this naive map would look with no spatial effects. 

```{r SIR-map, echo=FALSE, fig.height=6.5, fig.cap="SIR for Cancer in WA, 2015-2019", eval=T}
# Adding SIR column
wa$SIR <- wa$Count/wa$Population
pal = function(n) brewer.pal(n, "BuPu")
plot(wa["SIR"], pal = pal, nbreaks = 8, breaks = "equal", main="SIR Map", lwd=0.5)
pal = function(n) brewer.pal(n, "BuPu")
wa$se <- sqrt(wa$SIR/wa$Population)
plot(wa["se"], pal = pal, nbreaks = 8, breaks = "equal", main="SIR Map Standard Errors", lwd=0.5)
```
Observations:

- The east generally has less Cancer prevalence than the west does. Prevalence is most concentrated near the north-eastern regions of the map. Larger regions in the east have higher prevalence than those in the west, indicating that its not too dependent on how rural and urban an area is.

- SIRs generally range from 0 - 0.016, with a median value of 0.005. This is not too large of a range, but possibly the larger SIRs may be due to sparseness. There is a chance that these results are from sampling variation rather than true variation.

- Standard Errors are relatively low for the high density such as King and Pierce county. Instead we see highest SE in less populated tracts near the North and the West of the Seattle Metro Area, such as in Mason and western-Skagit county. Some of the regions with highest SIRs, in East-Jefferson, Kitsap, and King county have relatively low SEs. 

Table 2 shows the 10 tracts with the highest SIRs for Cancer, and also the associated Standard Errors and County names. We see that Clallam County has the tracts with the highest SIRs among the top 10 areas, making it a a region that potentially could use deeper study or interventions.

```{r, echo=FALSE, eval=T, fig.cap="Tracts with Highest SIRs"}
# Viewing a table of the tracts with highest SIRs
top10 <- head(arrange(wa,desc(SIR)), n = 10)
top10 <- subset(top10, select = c("County.Name", "Census.Tract.ID", "SIR", "se"))
top10 <- st_drop_geometry(top10)
colnames(top10) <- c('County','Census Tract ID','SIR', 'Standard Error')
knitr::kable(top10)
```

\newpage
## IID Estimates:

Prior to any spatial smoothing, we can assume a simple IID model for INLA to observed what posterior medians for prevalence would be. This can be extracted using a Poisson-Lognormal model in INLA, and taking no additional covariates. Here the denominator is the Population per region i.
```{r inla-iid,eval=T}
# Fit Poisson-Lognormal model in INLA:
model.fit0 <- inla(Count ~ 1 + f(Census.Tract.ID, model="iid"), data=wa, family="poisson", E=Population)
```

We can map the IID posterior medians of the relative risks and associated posterior standard deviations:
```{r, echo=FALSE, fig.height=6.5, fig.cap="Posterior Medians for Relative Risk with default priors", eval=T}
# Extracting the posterior medians using our fitted model
wa$fit0fitted <- model.fit0$summary.fitted.values$`0.5quant`
wa$fit0se <- model.fit0$summary.fitted.values$`sd`
# Mapping our results
pal = function(n) brewer.pal(n,"BuPu")
plot(wa["fit0fitted"], pal = pal, nbreaks = 8, breaks = "equal", main="Map of Posterior Medians (IID)", lwd=0.5)
plot(wa["fit0se"], pal = pal, nbreaks = 8, breaks = "equal", main="Posterior Standard Deviations", lwd=0.5)
```

Just assuming a simple IID model already shows a contrast to the plot of $Y_i$ counts prior. The trend where Eastern Washington had less prevalence than Western Washington is more apparent above. The regions near the Puget Sound and north close to the Salish Sea have relatively higher prevalence. Regions in the center/center-west continue to have lower prevalence rates in contrast. 

```{r, echo=FALSE, eval=T, fig.cap="Tracts with Highest IID Posterior Medians"}
# Viewing a table of the tracts with highest PMs
top10 <- head(arrange(wa,desc(fit0fitted)), n = 10)
top10 <- subset(top10, select = c("County.Name", "Census.Tract.ID", "fit0fitted", "fit0se"))
top10 <- st_drop_geometry(top10)
colnames(top10) <- c('County','Census Tract ID','Posterior Median', 'Posterior St. Dev.')
knitr::kable(top10)
```

Table Observations:

- We see that same top 9 Census Tracts for the IID model and the SIRs. Only the Island County tract from Table 2 is replaced by Jefferson County's Tract in the IID model.

- The Posterior Median values are also pretty similar to the SIRs calculated for the top ten highest prevalence census tracts.

- Clallam, Jefferson, and Skagit counties remain the highest priority counties for interventions.

```{r comparing-errors-1, fig.height=4.5, fig.width=4.5}
# Plotting standard deviations vs standard errors
ggplot(data.frame(psd=model.fit0$summary.fitted.values$`sd`,se=wa$se),
       aes(y=psd,x=se)) + geom_point() + labs(y="IID Standard Deviation",x="SIR Standard Error", 
                                              title='IID Posterior Standard Deviations vs. Standard Errors of SIRs') +
  theme(plot.title = element_text(hjust = 0.5)) + geom_abline(intercept=0,slope=1,color="red") #+ xlim(0,0.0025) + ylim(0,0.0025)
```
Observations:

- IID calculates Standard Deviations for areas with 0 cases, which explains the Benton County outlier with the highest errors.

- Generally we see a lot of alignment in Error between the IID model and the SIR SEs. We see more shrinkage at the high extremes for SIR errors above 0.001

- There is also slight shrinkage close to 0, to a lesser extent.

## BYM2 Spatial Smoothing

To better account for spatial smoothing towards neighboring areas, I will specify a BYM2 model for INLA instead of an IID model. The neighbor matrix for WA state census tracts is constructed using the ``prioritizr`` package in R.

```{r adjmatrix}
# compute adjacency matrix
#sf_use_s2(FALSE)
mat <- adjacency_matrix(wa)  
# Setting row and col name to HRA names in our neighbor matrix
colnames(mat) <- rownames(mat) <- wa$Census.Tract.ID
mat <- as.matrix(mat[1:dim(mat)[1], 1:dim(mat)[1]])
```


```{r BYM2-nocovars, message=FALSE, warning=FALSE}
# Assigning a region column with a numeric identifier
wa$region <- 1:nrow(wa)
# Running INLA with given specifications (no covariates) Default Priors
formula <- Count ~ 1 + f(region, model="bym2", graph=mat)

model.fit1 <- inla(formula, data=wa, family="poisson",E=Population, control.predictor=list(compute=TRUE),
                   control.compute=list(return.marginals.predictor=TRUE, config = TRUE))

model.fit1$summary.fixed[,1:5]
model.fit1$summary.hyper[,1:5]
```
```{r}
1/sqrt(model.fit1$summary.hyper[1,4])
model.fit1$summary.hyper[2,4]
```

Using a BYM2 model with INLA, with no covariates considered, the $\beta_0$ the posterior median is -5.239477 and the 95% interval is -5.25082 to -5.228175. The posterior median of the total standard variance of random effects is: `r 1/sqrt(model.fit1$summary.hyper[1,4])` and the posterior median for the proportion of the residual variation that is spatial $\phi$ is: `r model.fit1$summary.hyper[2,4]`. 

[Question]: The proportion of the total variance attributed to the spatial random effect is 0.76. Is that a significant amount? Can I reasonably say that there is a spatial component to Cancer incidences in the state?

```{r BYM2-plot1, echo=FALSE, fig.height=6.5, fig.cap="Posterior Medians for BYM2 Model", eval=T}
pal = function(n) brewer.pal(n,"BuPu")
# Extracting posterior median values and sd
wa$model1fitted <- model.fit1$summary.fitted.values$`0.5quant`
wa$fit1se <- model.fit1$summary.fitted.values$`sd`

# plotting
plot(wa["model1fitted"], pal = pal, nbreaks=8, breaks = "equal", main="Map of Posterior Medians (Spatial BYM2 Model)")
plot(wa["fit1se"], pal = pal, nbreaks = 8, breaks = "equal", main="Posterior Standard Deviations", lwd=0.5)
```

The effects of spatial smoothing is apparent in the North-West regions, where the relative risks are 'shared' between neighboring census tracts. Moreover all the regions towards the west have similar prevalence overall. We can extrapolate from this model that Cancer Incidence prevalence is concentrated in areas towards the northwest, closest to the Puget Sound/Salish Sea. As you extend further into the south-east, these rates are much lower. 


```{r comparing-errors-2, fig.height=4.5}
library(gridExtra)
# Plotting standard deviations vs standard errors
p1 <- ggplot(data.frame(psd=wa$fit1se,se=wa$se),
       aes(y=psd,x=se)) + geom_point() + labs(y="BYM2 Standard Deviation",x="SIR Standard Error", 
                                              title='BYM2 Posterior Standard Deviations vs. Standard Errors of SIRs') +
  theme(plot.title = element_text(hjust = 0.5)) + geom_abline(intercept=0,slope=1,color="red") + xlim(0, 0.0025) + ylim(0, 0.002)

p2 <- ggplot(data.frame(psd=wa$fit1se,se=wa$fit0se),
       aes(y=psd,x=se)) + geom_point() + labs(y="BYM2 Standard Deviation",x="IID Standard Deviation", 
                                              title='Posterior St. Dev BYM2 vs. IID') +
  theme(plot.title = element_text(hjust = 0.5)) + geom_abline(intercept=0,slope=1,color="red") + xlim(0, 0.0025) + ylim(0, 0.002)
grid.arrange(grobs = list(p1, p2), ncol = 2)
```
Observations:

- Compared to the SIR Standard Error and the Posterior St Devs. from the IID model, the BYM2 model has the lowest errors. We can observe shrinkage, which is most apparent for high error areas

- In General BYM2 is pretty aligned to both the SIR/IID errors, but does well too reduce the errors for high error areas, presumably due to spatial smoothing using neighbor matrix.

```{r, fig.height=4, fig.width=4}
# Plotting Posterior Median vs SIR
ggplot(data.frame(pmedian=model.fit1$summary.fitted.values$`0.5quant`,SIR=wa$SIR),
       aes(y=pmedian,x=SIR, size = wa$se)) + geom_point(alpha = 0.5) + labs(y="Posterior Median",x="SIR") + 
  labs(y="Posterior Median",x="SIR", title='Posterior Median Relative Risk against SIR') +
  theme(plot.title = element_text(hjust = 0.5)) + geom_abline(intercept=0,slope=1,color="red") #+ xlim(0,2.5) + ylim(0,2.5)
```
Compared to the calculated SIR values, the Posterior Medians from the BYM2 model is very similar. Again, we can notice some shrinkage, and also correction for regions with 0 cases reported. In addition to the known reduced errors, the BYM2 model provides a more reliable model for Cancer incidence relative risks.


## Spatial Model with Covariates

Having established a reliable BYM2 model for Cancer Prevalence in WA state, covariates can be introduced to understand exposure effects in regions, and the relationship it has to cancer relative risks. The covariates that this study will consider are the following:

1. PM2.5 Concentration (2014-2017): https://fortress.wa.gov/doh/wtn/WTNPortal/#!q0=4734 

2. Toxic Release from Facilities (2018-2020): https://fortress.wa.gov/doh/wtn/WTNPortal/#!q0=4732 

3. Housing Lead Exposure Risk (2015-2019): https://fortress.wa.gov/doh/wtn/WTNPortal/#!q0=722 

It should be noted that these covariates where measured at different time intervals and ranges. The Housing Lead Exposure risk falls in the same interval as the Cancer Incidence counts. However the PM2.5 concentrations and Toxic Releases have different intervals. PM2.5 have a 3 year span for collecting concentrations, whereas the Toxic Releases are across a 2 year span.

```{r read-covariates}
# Reading PM2.5
pm2.5 <- read.csv("PM2.5_Concentration.csv", header = TRUE)
colnames(pm2.5) <- c('County.Name',' Year.Group','Census.Tract.ID', 'PM.Concentration', 'IBL.Rank')
pm2.5 <- pm2.5[, c('Census.Tract.ID', 'PM.Concentration')]
# Reading in Toxicity
toxic <- read.csv("Toxic_Releases_from_Facilities.csv", header = TRUE)
colnames(toxic) <- c('County.Name','Census.Tract.ID', 'RSEI.Concentration', 'IBL.Rank')
toxic <- toxic[, c('Census.Tract.ID', 'RSEI.Concentration')]

# Reading in Lead Exposure
lead <- read.csv("Lead_Risk_from_Housing.csv", header = TRUE)
colnames(lead) <- c('County.Name','Census.Tract.ID', 'Units.Lead', 'Housing.Units', 'Percent.Units', 'IBL.Rank')
lead <- lead[, c('Census.Tract.ID', 'Units.Lead')]

wa2 <- merge(wa, pm2.5)
wa2 <- merge(wa2, toxic)
wa2 <- merge(wa2, lead)
```

To extrapolate the RSEI Toxic Release covariate and PM2.5 Concentrations to a 4 year interval, a yearly rate was calculated for each value and then the count was extrapolated to 4 years. To illustrate, since Toxic Releases covers a 2 year span for the counts, each census tract's values were divided by 2, and to find a simplified rate for the count, and then multiplied by 4 to extrapolate the count value for a time span that matches the cancer incidence counts. This makes an assumption that the rate would be constant for every year, but is necessary since the data for the selected time span is not readily available. Since all the data occurs around the span span from 2014-2020, this should still be applicable.

```{r rates-covars}
# dividing pm2.5 by 3 to get a yearly rate
values_rate <- wa2$PM.Concentration / 3
# multiplying by 4 to get an estimated count
wa2$Adj.PM.Concentration <- values_rate * 4

# multiplying by 4 to get an estimated count
wa2$Adj.RSEI.Concentration <- wa2$RSEI.Concentration * 2
```

```{r ICAR-Covars, echo=FALSE}
# Adding all three covariates
formula <- Count ~ 1 + Adj.PM.Concentration + Units.Lead + f(region, model="bym2", graph=mat)

model.fit2 <- inla(formula, data=wa2, family="poisson",E=Population, control.predictor=list(compute=TRUE),
                   control.compute=list(return.marginals.predictor=TRUE, config = TRUE))

model.fit2$summary.fixed[,1:5]
model.fit2$summary.hyper[,1:5]
```
Applying PM2.5 Concentrations as a covariate in our spatial model, the posterior mean for the intercept is -5.09. The posterior median for the relative risk associated with a unit increase in PM2.5 concentration is ``r round(exp(model.fit2$summary.fixed[2,4]), 3)``, which is $exp(\beta_1)|y = exp(-0.34)$. The 95% credible interval for the relative risk $exp(\beta_1)$ is [``r round(exp(model.fit2$summary.fixed[2,3]), 2)``, ``r round(exp(model.fit2$summary.fixed[2,5]), 2)``].

The posterior median of $\sigma_e$ is ``r 1/sqrt(model.fit2$summary.hyperpar[1, 4])`` with a 95% interval of [``r 1/sqrt(model.fit2$summary.hyperpar[1, 5])``, ``r 1/sqrt(model.fit2$summary.hyperpar[1, 3])``].

```{r table-covars}
# take the exponentiation results for interval and median
covar_df <- round(exp(model.fit2$summary.fixed[,3:5]), 4)
colnames(covar_df) <- c('Lower Bound','Posterior Median','Upper Bound')
knitr::kable(covar_df, caption = "Exponentiated Model Covariates")
```

```{r table-covars-hyper}
sigma_df <- 1/sqrt(model.fit2$summary.hyper[1,3:5])
hyper_df <- rbind(sigma_df, model.fit2$summary.hyper[2,3:5])
colnames(hyper_df) <- c('Lower Bound','Posterior Median','Upper Bound')
row.names(hyper_df) <- c('Variance of Random Effects', 'Phi for Region')
knitr::kable(hyper_df, caption = "Model Variance")
```