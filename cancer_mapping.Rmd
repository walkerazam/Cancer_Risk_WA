---
title: "Mapping Cancer Risk in Washington State"
author: |
  | Walker Azam
  | STAT/CSSS 554 Course Project
  | Date: March 13, 2023
output:
  pdf_document: default
  html_document: default
---

```{r setup-md, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
# Setting up RMarkdown
opts_chunk$set(collapse = TRUE, fig.align = "center", tidy = TRUE, 
               tidy.opts = list(blank = TRUE, width.cutoff = 60, 
                                strip.white = TRUE), warning = FALSE, 
               message = FALSE, cache = FALSE, echo=FALSE)
```

```{r setup, eval=T}
# Loading Libraries
library(RColorBrewer) # creates nice color schemes
library(classInt)     # finds class intervals for continuous variables
library(ggplot2)
library(rgdal)
library(SUMMER)
library(maps)
library(maptools)
library(dplyr)
library(sf)
library(INLA)
library(prioritizr)
```

## Introduction

In this project I will be mapping and predicting Cancer risk in Washington state at a census tract level. 

As noted by the Cancer Statistics Center from teh American Cancer Society, there are over 441 incident cases for cancer per 100,000 people living in Washington State, 2015-2019, and an estimated 44,630 new cases for 2023. In an effort to better understand possible environmental covariate factors of cancer rates in the state, and possibly inform resource allocation and plan interventions, I would like to perform disease mapping based on exposure covariates. Personal exposure information such as individuals' diets, genetics, or smoking habits will not be considered. Rather the purpose of the project is to understand if there are environmental risk exposures such as Air Quality, or harmful chemical exposures that may have an effect on Cancer risk. Moreover, the project will aim to highlight whether particular areas in Washington state are at high risk for cancer, which can result in more specific future studies to elucidate any potential reasons and interventions.

## Data Background

The data used in this project are collected from WA state resources, all publicly available online for use. Primarily the Cancer Incident counts are retrieved from the Washington State Department of Health's source for environmental public health data the Washington Tracking Network (WTN). All Cancer type incidences were selected for this project, occurring in a 5 Year Interval between 2015-2019, for both Sexes. The counts are based on the residential address for the patient at the time of diagnosis, which may not account of types of cancers that have longer latency periods -- which is a limitation of this study. The data provided is relavtively reliable, however there are 10 census tracts that have data suppressed to protect confidentiality. Since this comprises of 0.7% of the complete data, they were considered as 0 cases for the purposes of this project.

```{r read-data, fig.height=4.5, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide', fig.keep='all', fig.cap="WA State Census Tract Map"}
# Reading in WA state Census Tract Shapefiles
# Data from: https://ofm.wa.gov/washington-data-research/population-demographics/gis-data/census-geographic-files
washington <- rgdal::readOGR(dsn="tract10",layer="tract10")
plot(washington, main="Washington Census Tracts")
```

Washington has 1458 Census Tracts. From first figure it is apparent that the area between these census tracts are highly uneven. We can see that most of the tracts near the Seattle Metropolitan Area are small and dense, closeby the Puget Sound. In contrast, most of the central and eastern tracts are large and rural, just past the cascade mountain range. The far east areas are also larger, close to the Olympic national mountains. 

```{r sp-data}
# Converting WA census tract to a polygon DF
wmap <- SpatialPolygons(washington@polygons) # getting Geometries
washington$geometry <- st_as_sfc(wmap) # adding geometry column
wmap <- st_as_sf(washington)
# selecting important columns
wmap <- wmap[,c("GEOID10", "TRACTCE10", "INTPTLON10", "INTPTLAT10", "geometry")]
```

Now lets read in cancer incidence counts from 2015-2019:

```{r read-cancer}
# Reading cancer data (pre-cleaned)
cancer <- read.csv("Cancer_Incidence_2015-2019.csv", header = TRUE)
# Selecting Columns
cancer <- cancer[, c("County.Name", "Census.Tract.ID", "Count", "Population")]
# Assigning NULL values to 0
cancer$Count[cancer$Count == 'NULL'] <- 0
# Merging with spatial object
merge <- merge(cancer, wmap, by.x='Census.Tract.ID', by.y='GEOID10')
wa <- st_as_sf(merge)
# drop areas with 0 population (Water)
wa <- filter(wa, Population > 0)
```

Trying to map population from 2015-2019:
```{r population-map, fig.height=6.5, fig.cap="WA State Population Map, 2015-2019"}
pal = function(n) brewer.pal(n, "Oranges")
plot(wa["Population"], pal = pal, nbreaks = 8, breaks = "equal", lwd=0.5,
     main="Washington State's Population", sub='Combined Census Tract Population from 2015-2019')
```

As aforementioned, this project will look at Washington State's population from 2015-2019, aggregated by census tracts, and pulled from the WTN. This includes combined age groups and sexes. The total count for the population between 2015-2019 combined is 36,529,390. We can see from the map of the populations that the Seattle Metro Area is by far the most populated areas which is expected. All regions near the Puget Sound have high populations in general, such as King and Pierce County. We can also see a trend where the smaller census tract regions have much higher populations. There are some regions of high density away from the Seattle Metro Area, such as near Spokane in the East and Grant County, however most regions in the center, far west, and east are relatively rural and sparsely populated. 

Now mapping the raw counts of Cancer Incidences from 2015-2019:
```{r cancer-raw-map, fig.height=6.5, fig.cap="Raw Cancer Incidences, 2015-2019"}
pal = function(n) brewer.pal(n, "Purples")
# Assigning it to be Numeric
wa$Count <- as.numeric(wa$Count)
plot(wa["Count"], pal = pal, nbreaks = 8, breaks = "equal", lwd=0.5,
     main="Washington State Cancer Incidence Counts", sub='All Cancer Types, 2015-2019')
```

Looking at the map for the raw count of Cancer incidences in the state between 2015-2019, we see a general concordance between areas of high population and areas of high cancer incidence counts, as expected. For example, general the large regions in the center-east have low incidence counts. However, we can see some standout regions. For example some of the census tracts in Clallam county (North-west), where the Olympic National Parks are, have highest counts (more than King County/Seattle). Also in Gray's Harbor county, on the Western Border of the map, we see a census tract with a high raw count. Generally, this map shows a trend where regions West of the Cascade mountains have a higher incidence of Cancer than those towards the East.

```{r table-1, fig.cap="Table for Totals from 2015-2019", message=FALSE, warning=FALSE}
table <- cbind('Population Total' = 36529390, 'Case Total' = 211597)
knitr::kable(table)
```

The maps shown and discussed so far represent raw counts for population and cancer incidences, and do not take into account any form of spatial smoothing. This is important for sparse areas, where counts may be unreliable. The response variable in this study would be Cancer prevalence across all age groups in WA state, and a  Poisson distribution will be assumed for the disease. Even taking the combined counts for all Cancer types, the disease is relatively rare compared to the entire combined population for the project (See Table 1). 

The standardized morbidity rates (SMR) will be extrapolated from the incidence counts since morbidity data is much harder to acquire. To find the SMRs for each region, we can assume $Y_i$ and $E_i$, $i = 1,...,n$, denote the observed counts for the combined population in region $i$, $i = 1,...,n$. Assuming $SMR = Y_i/E_i$, we can observe how this naive map would look with no spatial effects. 

```{r SMR-map, echo=TRUE, fig.height=6.5, fig.cap="SMR for Cancer in WA, 2015-2019", eval=T}
# Adding SMR column
wa$SMR <- wa$Count/wa$Population
pal = function(n) brewer.pal(n, "BuPu")
plot(wa["SMR"], pal = pal, nbreaks = 8, breaks = "equal", main="SMR Map", lwd=0.5)
pal = function(n) brewer.pal(n, "BuPu")
wa$se <- sqrt(wa$SMR/wa$Population)
plot(wa["se"], pal = pal, nbreaks = 8, breaks = "equal", main="SMR Map Standard Errors", lwd=0.5)
```
Observations:

- The east generally has less Cancer prevalence than the west does. Prevalence is most concentrated near the north-eastern regions of the map. Larger regions in the east have higher prevalence than those in the west, indicating that its not too dependent on how rural and urban an area is.

- SMRs generally range from 0 - 0.016, with a median value of 0.005. This is not too large of a range, but possibly the larger SMRs may be due to sparseness. There is a chance that these results are from sampling variation rather than true variation.

- Standard Errors are relatively low for the high density such as King and Pierce county. Instead we see highest SE in less populated tracts near the North and the West of the Seattle Metro Area, such as in Mason and western-Skagit county. Some of the regions with highest SMRs, in East-Jefferson, Kitsap, and King county have relatively low SEs. 

Table 2 shows the 10 tracts with the highest SMRs for Cancer, and also the associated Standard Errors and County names. We see that Clallam County has the tracts with the highest SMRs among the top 10 areas, making it a a region that potentially could use deeper study or interventions.

```{r, echo=TRUE, eval=T, fig.cap="Tracts with Highest SMRs"}
# Viewing a table of the tracts with highest SMRs
top10 <- head(arrange(wa,desc(SMR)), n = 10)
top10 <- subset(top10, select = c("County.Name", "Census.Tract.ID", "SMR", "se"))
top10 <- st_drop_geometry(top10)
colnames(top10) <- c('County','Census Tract ID','SMR', 'Standard Error')
knitr::kable(top10)
```

## IID Estimates:

Prior to any spatial smoothing, we can assume a simple IID model for INLA to observed what posterior medians for prevalence would be. This can be extracted using a Poisson-Lognormal model in INLA, and taking no additional covariates. Here the denominator is the Population per region i.
```{r inla-iid,eval=T}
# Fit Poisson-Lognormal model in INLA:
model.fit0 <- inla(Count ~ 1 + f(Census.Tract.ID, model="iid"), data=wa, family="poisson", E=Population)
```

We can map the IID posterior medians of the relative risks and associated posterior standard deviations:
```{r, echo=TRUE, fig.height=6.5, fig.cap="Posterior Medians for Relative Risk with default priors", eval=T}
# Extracting the posterior medians using our fitted model
wa$fit0fitted <- model.fit0$summary.fitted.values$`0.5quant`
wa$fit0se <- model.fit0$summary.fitted.values$`sd`
# Mapping our results
pal = function(n) brewer.pal(n,"BuPu")
plot(wa["fit0fitted"], pal = pal, nbreaks = 8, breaks = "equal", main="Map of Posterior Medians (IID)", lwd=0.5)
plot(wa["fit0se"], pal = pal, nbreaks = 8, breaks = "equal", main="Posterior Standard Deviations", lwd=0.5)
```

Just assuming a simple IID model already shows a contrast to the plot of $Y_i$ counts prior. The trend where Eastern Washington had less prevalence than Western Washington is more apparent above. The regions near the Puget Sound and north close to the Salish Sea have relatively higher prevalence. Regions in the center/center-west continue to have lower prevalence rates in contrast. 

```{r, echo=TRUE, eval=T, fig.cap="Tracts with Highest IID Posterior Medians"}
# Viewing a table of the tracts with highest PMs
top10 <- head(arrange(wa,desc(fit0fitted)), n = 10)
top10 <- subset(top10, select = c("County.Name", "Census.Tract.ID", "fit0fitted", "fit0se"))
top10 <- st_drop_geometry(top10)
colnames(top10) <- c('County','Census Tract ID','Posterior Median', 'Posterior St. Dev.')
knitr::kable(top10)
```

Table Observations:

- We see that same top 9 Census Tracts for the IID model and the SMRs. Only the Island County tract from Table 2 is replaced by Jefferson County's Tract in the IID model.

- The Posterior Median values are also pretty similar to the SMRs calculated for the top ten highest prevalence census tracts.

- Clallam, Jefferson, and Skagit counties remain the highest priorty counties for interventions.

```{r comparing-errors-1, fig.height=4.5, fig.width=4.5}
# Plotting standard deviations vs standard errors
ggplot(data.frame(psd=model.fit0$summary.fitted.values$`sd`,se=wa$se),
       aes(y=psd,x=se)) + geom_point() + labs(y="IID Standard Deviation",x="SMR Standard Error", 
                                              title='IID Posterior Standard Deviations vs. Standard Errors of SMRs') +
  theme(plot.title = element_text(hjust = 0.5)) + geom_abline(intercept=0,slope=1,color="red") #+ xlim(0,0.0025) + ylim(0,0.0025)
```
Observations:

- IID calculates Standard Deviations for areas with 0 cases, which explains the Benton County outlier with the highest errors.

- Generally we see a lot of alignment in Error between the IID model and the SMR SEs. We see more shrinkage at the high extremes for SMR errors above 0.001

- There is also slight shrinkage close to 0, to a lesser extent.

## BYM2 Spatial Smoothing

To better account for spatial smoothing towards neighboring areas, I will specify a BYM2 model for INLA instead of an IID model. The neighbor matrix for WA state census tracts is constructed using the ``prioritizr`` package in R.

```{r adjmatrix}
# compute adjacency matrix
#sf_use_s2(FALSE)
mat <- adjacency_matrix(wa)  
# Setting row and col name to HRA names in our neighbor matrix
colnames(mat) <- rownames(mat) <- wa$Census.Tract.ID
mat <- as.matrix(mat[1:dim(mat)[1], 1:dim(mat)[1]])
```
